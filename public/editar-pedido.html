<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editar Pedido - Assados de Domingo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    .hamburger {
      display: none;
      flex-direction: column;
      cursor: pointer;
      padding: 10px;
    }
    .hamburger span {
      width: 25px;
      height: 3px;
      background: #333;
      margin: 3px 0;
      transition: 0.3s;
    }
    nav {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    nav a {
      text-decoration: none;
      color: #333;
      padding: 10px 20px;
      border-radius: 5px;
      transition: background 0.3s;
    }
    nav a:hover {
      background: #f0f0f0;
    }
    .content {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-width: 900px;
      margin: 0 auto;
      text-align: left;
    }
    .content h1 {
      color: #667eea;
      margin-bottom: 30px;
      text-align: center;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #333;
    }
    input[type="text"], select, textarea, input[type="number"] {
      width: 100%;
      padding: 12px 10px;
      margin-top: 8px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s;
      resize: vertical;
    }
    input[type="number"] {
      max-width: 100px;
    }
    input[type="text"]:focus, select:focus, textarea:focus, input[type="number"]:focus {
      outline: none;
      border-color: #667eea;
    }
    .produto-item {
      border: 1px solid #ddd;
      padding: 15px 20px;
      margin: 10px 0;
      background: #f9f9f9;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    .produto-info {
      flex: 1 1 250px;
      font-weight: 600;
      color: #333;
    }
    .produto-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .produto-controls label {
      margin: 0;
      font-weight: normal;
      color: #555;
    }
    .produto-controls input[type="number"] {
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 80px;
      font-size: 14px;
    }
    .produto-controls button {
      background: transparent;
      border: none;
      color: #d9534f;
      font-weight: bold;
      font-size: 18px;
      cursor: pointer;
      padding: 6px 10px;
      transition: color 0.3s;
    }
    .produto-controls button:hover {
      color: #b52b27;
    }
    #loading {
      text-align: center;
      padding: 50px;
      font-size: 18px;
      color: white;
      font-weight: bold;
    }
    h2, h3 {
      margin-top: 40px;
      color: #444;
    }
    .btn-group {
      margin-top: 40px;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      flex-wrap: wrap;
    }
    button.btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
    }
    button.btn-primary:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      transform: translateY(-2px);
    }
    button.btn-secondary {
      background: #ccc;
      color: #333;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button.btn-secondary:hover {
      background: #bbb;
    }
    @media (max-width: 768px) {
      .hamburger {
        display: flex;
      }
      nav {
        display: none;
        width: 100%;
        flex-direction: column;
        margin-top: 15px;
      }
      nav.active {
        display: flex;
      }
      nav a {
        width: 100%;
        text-align: center;
      }
      .content {
        padding: 20px;
      }
      .btn-group {
        justify-content: center;
      }
      .produto-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .produto-controls {
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">üçó Assados de Domingo</div>
      <div class="hamburger" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <nav id="nav">
        <a href="index.html">In√≠cio</a>
        <a href="cadastro-cliente.html">Cadastrar Cliente</a>
        <a href="lista-clientes.html">Listar Clientes</a>
        <a href="lista-produtos.html">Listar Produtos</a>
        <a href="lista-pedidos.html">Listar Pedidos</a>
      </nav>
    </header>

    <div class="content">
      <div id="loading">Carregando pedido...</div>

      <div id="formContainer" style="display: none;">
        <h1>Editar Pedido #<span id="comandaDisplay"></span></h1>

        <form id="editarPedidoForm">
          <label for="cliente">Cliente:</label>
          <select id="cliente" required></select>

          <label for="tipo_entrega">Tipo de Entrega:</label>
          <select id="tipo_entrega" required>
            <option value="Local">Local</option>
            <option value="Entrega">Entrega</option>
          </select>

          <label for="status">Status:</label>
          <select id="status" required></select>

          <label for="observacao">Observa√ß√£o:</label>
          <textarea id="observacao" rows="4"></textarea>

          <h2>Produtos do Pedido</h2>
          <div id="produtosAtuaisContainer"></div>

          <h3>Adicionar Produtos</h3>
          <div id="produtosDisponiveisContainer"></div>

          <div class="btn-group">
            <button type="submit" class="btn-primary">Salvar Altera√ß√µes</button>
            <button type="button" class="btn-secondary" onclick="window.location.href='lista-pedidos.html'">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    function toggleMenu() {
      const nav = document.getElementById('nav');
      nav.classList.toggle('active');
    }

    const urlParams = new URLSearchParams(window.location.search);
    const idPedido = urlParams.get('id');

    if (!idPedido) {
      alert('ID do pedido n√£o fornecido');
      window.location.href = 'lista-pedidos.html';
    }

    let pedidoAtual = null;
    let todosClientes = [];
    let todosProdutos = [];
    let todosStatus = [];
    let produtosSelecionados = [];

    const statusMap = {
      1: 'Aguardando Preparo',
      2: 'Em Preparo',
      3: 'Finalizado',
      4: 'Entregue',
      5: 'Cancelado'
    };

    Promise.all([
      fetch(`/pedidos/${idPedido}`).then(res => res.json()),
      fetch('/clientes').then(res => res.json()),
      fetch('/produtos').then(res => res.json())
    ])
      .then(([pedido, clientes, produtos]) => {
        pedidoAtual = pedido;
        todosClientes = clientes;
        todosProdutos = produtos;
        todosStatus = Object.entries(statusMap).map(([id, nome]) => ({ id: parseInt(id), nome }));

        produtosSelecionados = pedido.itens.map(item => ({
          id_produto: item.id_produto,
          nome_produto: item.nome_produto,
          qtd_produto: item.qtd_produto,
          valor: item.valor
        }));

        renderizarFormulario();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('formContainer').style.display = 'block';
      })
      .catch(err => {
        console.error('Erro ao carregar dados:', err);
        alert('Erro ao carregar pedido');
        window.location.href = 'lista-pedidos.html';
      });

    function renderizarFormulario() {
      document.getElementById('comandaDisplay').textContent = pedidoAtual.comanda;

      // Preencher clientes
      const selectCliente = document.getElementById('cliente');
      selectCliente.innerHTML = '';
      todosClientes.forEach(cliente => {
        const option = document.createElement('option');
        option.value = cliente.id;
        option.textContent = cliente.nome;
        if (cliente.id === pedidoAtual.id_cliente) option.selected = true;
        selectCliente.appendChild(option);
      });

      // Tipo de entrega
      document.getElementById('tipo_entrega').value = pedidoAtual.tipo_entrega;

      // Status
      const selectStatus = document.getElementById('status');
      selectStatus.innerHTML = '';
      todosStatus.forEach(status => {
        const option = document.createElement('option');
        option.value = status.id;
        option.textContent = status.nome;
        if (status.id === pedidoAtual.id_status) option.selected = true;
        selectStatus.appendChild(option);
      });

      // Observa√ß√£o
      document.getElementById('observacao').value = pedidoAtual.observacao || '';

      renderizarProdutosAtuais();
      renderizarProdutosDisponiveis();
    }

    function renderizarProdutosAtuais() {
      const container = document.getElementById('produtosAtuaisContainer');
      container.innerHTML = '';

      if (produtosSelecionados.length === 0) {
        container.innerHTML = '<p>Nenhum produto no pedido.</p>';
        return;
      }

      produtosSelecionados.forEach((produto, index) => {
        const div = document.createElement('div');
        div.classList.add('produto-item');
        div.innerHTML = `
          <div class="produto-info">
            <strong>${produto.nome_produto}</strong> - R$ ${produto.valor.toFixed(2)}
          </div>
          <div class="produto-controls">
            <label for="qtd-prod-${index}">Quantidade:</label>
            <input type="number" id="qtd-prod-${index}" min="1" value="${produto.qtd_produto}" onchange="atualizarQuantidade(${index}, this.value)" />
            <button type="button" title="Remover produto" onclick="removerProduto(${index})">&times;</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function renderizarProdutosDisponiveis() {
      const container = document.getElementById('produtosDisponiveisContainer');
      container.innerHTML = '';

      const produtosNaoSelecionados = todosProdutos.filter(p =>
        !produtosSelecionados.some(ps => ps.id_produto === p.id)
      );

      if (produtosNaoSelecionados.length === 0) {
        container.innerHTML = '<p>Todos os produtos j√° foram adicionados.</p>';
        return;
      }

      produtosNaoSelecionados.forEach(produto => {
        const div = document.createElement('div');
        div.classList.add('produto-item');
        div.innerHTML = `
          <div class="produto-info">
            <strong>${produto.nome}</strong> - R$ ${parseFloat(produto.valor).toFixed(2)}
          </div>
          <div class="produto-controls">
            <label for="qtd-${produto.id}">Quantidade:</label>
            <input type="number" id="qtd-${produto.id}" min="1" value="1" />
            <button type="button" title="Adicionar produto" onclick="adicionarProduto(${produto.id})">+</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function atualizarQuantidade(index, novaQtd) {
      const qtd = parseInt(novaQtd);
      if (!isNaN(qtd) && qtd > 0) {
        produtosSelecionados[index].qtd_produto = qtd;
      }
    }

    function removerProduto(index) {
      produtosSelecionados.splice(index, 1);
      renderizarProdutosAtuais();
      renderizarProdutosDisponiveis();
    }

    function adicionarProduto(idProduto) {
      const produto = todosProdutos.find(p => p.id === idProduto);
      const qtdInput = document.getElementById(`qtd-${idProduto}`);
      const qtd = parseInt(qtdInput.value) || 1;

      produtosSelecionados.push({
        id_produto: produto.id,
        nome_produto: produto.nome,
        qtd_produto: qtd,
        valor: parseFloat(produto.valor)
      });

      renderizarProdutosAtuais();
      renderizarProdutosDisponiveis();
    }

    document.getElementById('editarPedidoForm').addEventListener('submit', function(e) {
      e.preventDefault();

      if (produtosSelecionados.length === 0) {
        alert('O pedido deve ter pelo menos um produto.');
        return;
      }

      const dadosAtualizados = {
        id_cliente: parseInt(document.getElementById('cliente').value),
        tipo_entrega: document.getElementById('tipo_entrega').value,
        id_status: parseInt(document.getElementById('status').value),
        observacao: document.getElementById('observacao').value,
        produtos: produtosSelecionados.map(p => ({
          id_produto: p.id_produto,
          qtd_produto: p.qtd_produto
        }))
      };

      fetch(`/pedidos/${idPedido}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dadosAtualizados)
      })
      .then(res => {
        if (!res.ok) {
          return res.json().then(err => Promise.reject(err));
        }
        return res.json();
      })
      .then(() => {
        alert('Pedido atualizado com sucesso!');
        window.location.href = 'lista-pedidos.html';
      })
      .catch(err => {
        console.error('Erro ao atualizar pedido:', err);
        alert('Erro ao atualizar pedido: ' + (err.error || err.message || 'Erro desconhecido'));
      });
    });
  </script>
</body>
</html>
